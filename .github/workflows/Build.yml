name: Build APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - uses: android-actions/setup-android@v3
      
    - run: |
        mkdir -p app/src/main/java/com/shortsblocker/tv
        mkdir -p app/src/main/res/xml
        mkdir -p app/src/main/res/values
        mkdir -p gradle/wrapper
        
    - run: |
        cat > gradle.properties << 'EOF'
        org.gradle.jvmargs=-Xmx4096m -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.enableJetifier=true
        android.nonTransitiveRClass=true
        EOF
        
    - run: |
        cat > build.gradle << 'EOF'
        plugins {
            id 'com.android.application' version '7.4.2' apply false
            id 'org.jetbrains.kotlin.android' version '1.8.20' apply false
        }
        EOF
        
    - run: |
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories { google() ; mavenCentral() ; gradlePluginPortal() }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories { google() ; mavenCentral() }
        }
        rootProject.name = "ShortsBlocker"
        include ':app'
        EOF
        
    - run: |
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-7.5-bin.zip
        networkTimeout=10000
        validateDistributionUrl=true
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        
    - run: |
        cat > app/build.gradle << 'EOF'
        plugins {
            id 'com.android.application'
            id 'org.jetbrains.kotlin.android'
        }
        android {
            namespace 'com.shortsblocker.tv'
            compileSdk 33
            defaultConfig {
                applicationId "com.shortsblocker.tv"
                minSdk 21
                targetSdk 33
                versionCode 1
                versionName "1.0.0"
            }
            buildTypes {
                debug {
                    debuggable true
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
            kotlinOptions { jvmTarget = '1.8' }
        }
        dependencies {
            implementation 'androidx.core:core-ktx:1.10.1'
        }
        EOF
        
    - run: |
        cat > app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.BIND_ACCESSIBILITY_SERVICE" />
            <uses-feature android:name="android.software.leanback" android:required="false" />
            <uses-feature android:name="android.hardware.touchscreen" android:required="false" />
            <application
                android:icon="@android:drawable/ic_menu_close_clear_cancel"
                android:label="ShortsBlocker"
                android:theme="@android:style/Theme.NoDisplay">
                <service
                    android:name=".BlockerService"
                    android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE"
                    android:exported="true">
                    <intent-filter>
                        <action android:name="android.accessibilityservice.AccessibilityService" />
                    </intent-filter>
                    <meta-data
                        android:name="android.accessibilityservice"
                        android:resource="@xml/config" />
                </service>
            </application>
        </manifest>
        EOF
        
    - run: |
        cat > app/src/main/res/xml/config.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <accessibility-service xmlns:android="http://schemas.android.com/apk/res/android"
            android:description="Block YouTube Shorts"
            android:packageNames="com.google.android.youtube.tv,com.google.android.youtube"
            android:accessibilityEventTypes="typeWindowStateChanged|typeWindowContentChanged"
            android:accessibilityFlags="flagRetrieveInteractiveWindows"
            android:canRetrieveWindowContent="true"
            android:notificationTimeout="500" />
        EOF
        
    - run: |
        cat > app/src/main/res/values/strings.xml << 'EOF'
        <resources>
            <string name="app_name">ShortsBlocker</string>
        </resources>
        EOF
        
    - run: |
        cat > app/src/main/java/com/shortsblocker/tv/BlockerService.kt << 'EOF'
        package com.shortsblocker.tv
        import android.accessibilityservice.AccessibilityService
        import android.content.Context
        import android.os.Handler
        import android.os.Looper
        import android.view.accessibility.AccessibilityEvent
        import android.view.accessibility.AccessibilityNodeInfo
        import android.widget.Toast
        
        class BlockerService : AccessibilityService() {
            private val handler = Handler(Looper.getMainLooper())
            private var lastBlock = 0L
            private val PREFS = "Prefs"
            private val KEY = "enabled"
            
            override fun onAccessibilityEvent(event: AccessibilityEvent) {
                if (!isEnabled()) return
                val pkg = event.packageName?.toString() ?: return
                if (!pkg.contains("youtube")) return
                if (System.currentTimeMillis() - lastBlock < 2000) return
                
                rootInActiveWindow?.let { root ->
                    if (findShorts(root)) {
                        performGlobalAction(GLOBAL_ACTION_BACK)
                        handler.postDelayed({
                            rootInActiveWindow?.let {
                                if (findShorts(it)) performGlobalAction(GLOBAL_ACTION_BACK)
                                it.recycle()
                            }
                        }, 500)
                        lastBlock = System.currentTimeMillis()
                        handler.post { Toast.makeText(this, "Shorts Blocked", Toast.LENGTH_SHORT).show() }
                    }
                    root.recycle()
                }
            }
            
            private fun isEnabled(): Boolean {
                return try {
                    applicationContext.getSharedPreferences(PREFS, Context.MODE_PRIVATE).getBoolean(KEY, true)
                } catch (e: Exception) { true }
            }
            
            private fun findShorts(node: AccessibilityNodeInfo): Boolean {
                val queue = ArrayDeque<AccessibilityNodeInfo>()
                queue.add(node)
                var depth = 0
                while (queue.isNotEmpty() && depth < 15) {
                    val n = queue.removeFirst()
                    val id = n.viewIdResourceName?.lowercase() ?: ""
                    val desc = n.contentDescription?.toString()?.lowercase() ?: ""
                    if (id.contains("short") || id.contains("reel") || desc.contains("shorts")) {
                        return true
                    }
                    for (i in 0 until n.childCount) n.getChild(i)?.let { queue.add(it) }
                    depth++
                }
                return false
            }
            
            override fun onInterrupt() {}
        }
        EOF
        
    - name: Create gradlew script
      run: |
        cat > gradlew << 'SCRIPT'
        #!/bin/sh
        #
        # Copyright © 2015-2021 the original authors.
        #
        # Licensed under the Apache License, Version 2.0 (the "License");
        # you may not use this file except in compliance with the License.
        # You may obtain a copy of the License at
        #
        #      https://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing, software
        # distributed under the License is distributed on an "AS IS" BASIS,
        # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        # See the License for the specific language governing permissions and
        # limitations under the License.
        #
        ##############################################################################
        #
        #   Gradle start up script for POSIX generated by Gradle.
        #
        #   Important for running:
        #
        #   (1) You need a POSIX-compliant shell to run this script. If your /bin/sh is
        #       noncompliant, but you have some other compliant shell such as ksh or
        #       bash, then to run this script, type that shell name before the whole
        #       command line, like:
        #
        #           ksh Gradle
        #
        #       Busybox and similar reduced shells will NOT work, because this script
        #       requires all of these POSIX shell features:
        #         * functions;
        #         * expansions «$var», «${var}», «${var:-default}», «${var+SET}»,
        #           «${var#prefix}», «${var%suffix}», and «$( cmd )»;
        #         * compound commands having a testable exit status, especially «case»;
        #         * various built-in commands including «command», «set», and «ulimit».
        #
        #   Important for patching:
        #
        #   (2) This script targets any POSIX shell, so it avoids extensions provided
        #       by Bash, Ksh, etc; in particular arrays are avoided.
        #
        #       The "traditional" style of «gradlew» to use for this script is to avoid
        #       relying on platforms specific paths and environment names; rather it
        #       negotiates the path to «GRADLE_HOME» (where gradle is installed) from
        #       the current working directory through the project structure.
        #
        ##############################################################################
        
        # Attempt to set APP_HOME
        
        # Resolve links: $0 may be a link
        app_path=$0
        
        # Need this for daisy-chained symlinks.
        while
            APP_HOME=${app_path%"${app_path##*/}"}  # leaves a trailing /; empty if no leading path
            [ -h "$app_path" ]
        do
            ls=$( ls -ld "$app_path" )
            link=${ls#*' -> '}
            case $link in             #(
              /*)   app_path=$link ;; #(
              *)    app_path=$APP_HOME$link ;;
            esac
        done
        
        APP_HOME=$( cd "${APP_HOME:-./}" && pwd -P ) || exit
        
        APP_NAME="Gradle"
        APP_BASE_NAME=${0##*/}
        
        # Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
        DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'
        
        # Use the maximum available, or set MAX_FD != -1 to use that value.
        MAX_FD=maximum
        
        warn () {
            echo "$*"
        } >&2
        
        die () {
            echo
            echo "$*"
            echo
            exit 1
        } >&2
        
        # OS specific support (must be 'true' or 'false').
        cygwin=false
        msys=false
        darwin=false
        nonstop=false
        case "$( uname )" in                #(
          CYGWIN* )         cygwin=true  ;; #(
          Darwin* )         darwin=true  ;; #(
          MSYS* | MINGW* )  msys=true    ;; #(
          NONSTOP* )        nonstop=true ;;
        esac
        
        CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
        
        
        # Determine the Java command to use to start the JVM.
        if [ -n "$JAVA_HOME" ] ; then
            if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
                # IBM's JDK on AIX uses strange locations for the executables
                JAVACMD=$JAVA_HOME/jre/sh/java
            else
                JAVACMD=$JAVA_HOME/bin/java
            fi
            if [ ! -x "$JAVACMD" ] ; then
                die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
        
        Please set the JAVA_HOME variable in your environment to match the
        location of your Java installation."
            fi
        else
            JAVACMD=java
            which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
        
        Please set the JAVA_HOME variable in your environment to match the
        location of your Java installation."
        fi
        
        # Increase the maximum file descriptors if we can.
        if ! "$cygwin" && ! "$darwin" && ! "$nonstop" ; then
            case $MAX_FD in #(
              max*|MAX*)
                MAX_FD=$( ulimit -H -n ) ||
                    warn "Could not query maximum file descriptor limit"
            esac
            case $MAX_FD in  #(
              '' | soft) :;; #(
              *)
                ulimit -n "$MAX_FD" ||
                    warn "Could not set maximum file descriptor limit to $MAX_FD"
            esac
        fi
        
        # Collect all arguments for the java command, stacking in reverse order:
        #   * args from the command line
        #   * the main class name
        #   * -classpath
        #   * -D...appname settings
        #   * --module-path (only if needed)
        #   * DEFAULT_JVM_OPTS, JAVA_OPTS, and GRADLE_OPTS environment variables.
        
        # For Cygwin or MSYS, switch paths to Windows format before running java
        if "$cygwin" || "$msys" ; then
            APP_HOME=$( cygpath --path --mixed "$APP_HOME" )
            CLASSPATH=$( cygpath --path --mixed "$CLASSPATH" )
            
            JAVACMD=$( cygpath --unix "$JAVACMD" )
        
        fi
        
        # Collect all arguments for the java command;
        #   * $DEFAULT_JVM_OPTS, $JAVA_OPTS, and $GRADLE_OPTS can contain fragments of
        #     temporary files.
        #   * For example: GRADLE_OPTS="-XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"
        
        set -- \
                "-Dorg.gradle.appname=$APP_BASE_NAME" \
                -classpath "$CLASSPATH" \
                org.gradle.wrapper.GradleWrapperMain \
                "$@"
        
        # Use "xargs" to parse quoted args.
        #
        # With -n://services.gradle.org/distributions/gradle-7.5-bin.zip
        # Erase the args below to be able to build on Raspberry Pi.
        # See: https://github.com/gradle/gradle/issues/209977
        exec "$JAVACMD" "$@"
        SCRIPT
        chmod +x gradlew
        
    - run: mkdir -p gradle/wrapper && ls -la gradlew
        
    - name: Download gradle wrapper jar
      run: |
        curl -L -o gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v7.5.0/gradle/wrapper/gradle-wrapper.jar
        
    - name: Build APK
      run: |
        ./gradlew clean assembleDebug
        
    - name: Check Output
      run: ls -lh app/build/outputs/apk/debug/
      
    - uses: actions/upload-artifact@v4
      with:
        name: ShortsBlocker-TV
        path: app/build/outputs/apk/debug/app-debug.apk
